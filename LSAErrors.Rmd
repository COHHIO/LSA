---
title: "LSA Errors & Warnings"
author: "Genelle Denzin"
date: "March 21, 2019"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

library(readxl)
library(tidyverse)
library(gt)
library(janitor)
library(plotly)
```

## Data Quality Flags Summary

Both years together, all CoC flags

```{r categories_plot}

coc_2018 <- read_xlsx(
  "data/errors_warnings_1_2018.xlsx",
  sheet = 2,
  range = "A1",
  col_names = "CoC"
) %>%
  pull(CoC)

coc_2019 <- read_xlsx(
  "data/errors_warnings_1_2019.xlsx",
  sheet = 2,
  range = "A1",
  col_names = "CoC"
) %>%
  pull(CoC)

coc <- if_else(coc_2018 == coc_2019,
               coc_2018,
               "Mismatching CoCs")

flags_2018 <- read_xlsx(
  "data/errors_warnings_1_2018.xlsx",
  sheet = 4,
  skip = 4,
  col_types = "text"
)

flags_2019 <- read_xlsx(
  "data/errors_warnings_1_2019.xlsx",
  sheet = 4,
  skip = 4,
  col_types = "text"
)

flags_all <- rbind(flags_2018, flags_2019) %>% 
  clean_names() %>% unique() %>%
  filter(!is.na(id_number))

flag_categories <- flags_all %>%
  group_by(type, category) %>%
  summarise(NumberErrors = n()) %>%
  ungroup() %>% 
  arrange(desc(NumberErrors)) 

plot_ly(
  flag_categories %>%
    arrange(desc(NumberErrors)) %>%
    head(8L),
  x = ~ reorder(category, desc(NumberErrors)),
  y = ~ NumberErrors,
  type = 'bar',
  color = ~ category
) %>%
  layout(
    title = "LSA Categories",
    showlegend = FALSE,
    xaxis =  list(
      title = ""
    )
  )
```


## Errors vs Warnings

```{r errorswarnings}

flag_type <- flags_all %>%
  group_by(type) %>%
  summarise(Flags = n()) %>%
  ungroup() %>% 
  arrange(desc(Flags)) 

plot_ly(
  flag_categories %>%
    arrange(desc(NumberErrors)),
  x = ~ reorder(type, desc(NumberErrors)),
  y = ~ NumberErrors,
  type = 'bar',
  name = ~ category,
  color = ~ category,
  colors = 'Blues'
) %>%
  layout(
    title = 'Errors and Warnings',
    showlegend = FALSE,
    xaxis = list(title = ''),
    yaxis = list(title = 'Count'),
    barmode = 'stack'
  )

```


## Categories Detail

```{r categories_detail}
gt(flag_categories)

```

## Flag Descriptions

```{r descriptions}

flag_descriptions <- flags_all %>%
  group_by(id_number, type, category, description_7) %>%
  summarise(NumberErrors = n()) %>%
  ungroup()

toptenflagtypes <- flag_descriptions %>% arrange(desc(NumberErrors)) %>% head(10L)

gt(toptenflagtypes)

```


